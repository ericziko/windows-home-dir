"use strict";var h=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var se=h(I=>{"use strict";Object.defineProperty(I,"__esModule",{value:!0});I.ClickHouseLogLevel=I.LogWriter=I.DefaultLogger=void 0;var Pe=class{trace({module:e,message:r,args:n}){let s=[K({module:e,message:r,level:"TRACE"})];n&&s.push(`
Arguments:`,n),console.debug(...s)}debug({module:e,message:r,args:n}){let s=[K({module:e,message:r,level:"DEBUG"})];n&&s.push(`
Arguments:`,n),console.debug(...s)}info({module:e,message:r,args:n}){let s=[K({module:e,message:r,level:"INFO"})];n&&s.push(`
Arguments:`,n),console.info(...s)}warn({module:e,message:r,args:n,err:s}){let i=[K({module:e,message:r,level:"WARN"})];n&&i.push(`
Arguments:`,n),s&&i.push(`
Caused by:`,s),console.warn(...i)}error({module:e,message:r,args:n,err:s}){let i=[K({module:e,message:r,level:"ERROR"})];n&&i.push(`
Arguments:`,n),i.push(`
Caused by:`,s),console.error(...i)}};I.DefaultLogger=Pe;var Ce=class{constructor(e,r,n){Object.defineProperty(this,"logger",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"module",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"logLevel",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.logLevel=n??R.OFF,this.info({message:`Log level is set to ${R[this.logLevel]}`})}trace(e){this.logLevel<=R.TRACE&&this.logger.trace({...e,module:e.module??this.module})}debug(e){this.logLevel<=R.DEBUG&&this.logger.debug({...e,module:e.module??this.module})}info(e){this.logLevel<=R.INFO&&this.logger.info({...e,module:e.module??this.module})}warn(e){this.logLevel<=R.WARN&&this.logger.warn({...e,module:e.module??this.module})}error(e){this.logLevel<=R.ERROR&&this.logger.error({...e,module:e.module??this.module})}};I.LogWriter=Ce;var R;(function(t){t[t.TRACE=0]="TRACE",t[t.DEBUG=1]="DEBUG",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.OFF=127]="OFF"})(R||(I.ClickHouseLogLevel=R={}));function K({level:t,module:e,message:r}){return`[${new Date().toISOString()}][${t}][@clickhouse/client][${e}] ${r}`}});var Ne=h(q=>{"use strict";Object.defineProperty(q,"__esModule",{value:!0});q.prepareConfigWithURL=mr;q.getConnectionParams=pr;q.mergeConfigs=ht;q.createUrl=qe;q.loadConfigOptionsFromURL=mt;q.booleanConfigURLValue=ie;q.numberConfigURLValue=je;q.enumConfigURLValue=pt;var ft=se();function mr(t,e,r){let n={...t};n.additional_headers!==void 0&&(e.warn({module:"Config",message:'"additional_headers" is deprecated. Use "http_headers" instead.'}),n.http_headers=n.additional_headers,delete n.additional_headers);let s;n.host!==void 0?(e.warn({module:"Config",message:'"host" is deprecated. Use "url" instead.'}),s=qe(n.host),delete n.host):s=qe(n.url);let[i,o]=mt(s,r),u=ht(n,o,e);return u.pathname!==void 0&&(i.pathname=u.pathname),u.url=i,u}function pr(t,e){let r;if(t.access_token!==void 0){if(t.username!==void 0||t.password!==void 0)throw new Error("Both access token and username/password are provided in the configuration. Please use only one authentication method.");r={access_token:t.access_token,type:"JWT"}}else r={username:t.username??"default",password:t.password??"",type:"Credentials"};return{auth:r,url:t.url,application_id:t.application,request_timeout:t.request_timeout??3e4,max_open_connections:t.max_open_connections??10,compression:{decompress_response:t.compression?.response??!1,compress_request:t.compression?.request??!1},database:t.database??"default",log_writer:new ft.LogWriter(e,"Connection",t.log?.level),keep_alive:{enabled:t.keep_alive?.enabled??!0},clickhouse_settings:t.clickhouse_settings??{},http_headers:t.http_headers??{}}}function ht(t,e,r){function n(i,o,u=[]){for(let l of Object.keys(o))if(typeof o[l]=="object")n(i,o[l],u.concat(l));else{let c=i;for(let f of u)c[f]===void 0&&(c[f]={}),c=c[f];if(c[l]!==void 0){let f=u.concat(l).join(".");r.warn({module:"Config",message:`"${f}" is overridden by a URL parameter.`})}c[l]=o[l]}}let s={...t};return n(s,e),s}function qe(t){let e;try{if(typeof t=="string"||t instanceof URL)e=new URL(t);else return new URL("http://localhost:8123")}catch(r){throw new Error("ClickHouse URL is malformed. Expected format: http[s]://[username:password@]hostname:port[/database][?param1=value1&param2=value2]",{cause:r})}if(e.protocol!=="http:"&&e.protocol!=="https:")throw new Error(`ClickHouse URL protocol must be either http or https. Got: ${e.protocol}`);return e}function mt(t,e){let r={};t.username.trim()!==""&&(r.username=t.username),t.password!==""&&(r.password=t.password),t.pathname.trim().length>1&&(r.database=t.pathname.slice(1));let n=[...t.searchParams.keys()];if(n.length>0){let i=new Set,o="clickhouse_setting_",u="ch_",l="http_header_";if(n.forEach(c=>{let d=!0,f=t.searchParams.get(c);if(c.startsWith(o)){let g=c.slice(o.length);r.clickhouse_settings===void 0&&(r.clickhouse_settings={}),r.clickhouse_settings[g]=f}else if(c.startsWith(u)){let g=c.slice(u.length);r.clickhouse_settings===void 0&&(r.clickhouse_settings={}),r.clickhouse_settings[g]=f}else if(c.startsWith(l)){let g=c.slice(l.length);r.http_headers===void 0&&(r.http_headers={}),r.http_headers[g]=f}else switch(c){case"application":r.application=f;break;case"pathname":r.pathname=f;break;case"session_id":r.session_id=f;break;case"request_timeout":r.request_timeout=je({key:c,value:f,min:0});break;case"max_open_connections":r.max_open_connections=je({key:c,value:f,min:1});break;case"compression_request":r.compression===void 0&&(r.compression={}),r.compression.request=ie({key:c,value:f});break;case"compression_response":r.compression===void 0&&(r.compression={}),r.compression.response=ie({key:c,value:f});break;case"log_level":r.log===void 0&&(r.log={}),r.log.level=pt({key:c,value:f,enumObject:ft.ClickHouseLogLevel});break;case"keep_alive_enabled":r.keep_alive===void 0&&(r.keep_alive={}),r.keep_alive.enabled=ie({key:c,value:f});break;case"access_token":r.access_token=f;break;default:d=!1,i.add(c);break}d&&t.searchParams.delete(c)}),e!==null){let c=e(r,t);r=c.config,i.size>0&&c.handled_params.forEach(d=>i.delete(d)),c.unknown_params.size>0&&c.unknown_params.forEach(d=>i.add(d))}if(i.size>0)throw new Error(`Unknown URL parameters: ${Array.from(i).join(", ")}`)}return[new URL(`${t.protocol}//${t.host}`),r]}function ie({key:t,value:e}){let r=e.trim();if(r==="true"||r==="1")return!0;if(r==="false"||r==="0")return!1;throw new Error(`"${t}" has invalid boolean value: ${r}. Expected one of: 0, 1, true, false.`)}function je({key:t,value:e,min:r,max:n}){let s=e.trim(),i=Number(s);if(isNaN(i))throw new Error(`"${t}" has invalid numeric value: ${s}`);if(r!==void 0&&i<r)throw new Error(`"${t}" value ${s} is less than min allowed ${r}`);if(n!==void 0&&i>n)throw new Error(`"${t}" value ${s} is greater than max allowed ${n}`);return i}function pt({key:t,value:e,enumObject:r}){let n=Object.keys(r).filter(i=>isNaN(Number(i))),s=e.trim();if(!n.includes(s)){let i=n.join(", ");throw new Error(`"${t}" has invalid value: ${s}. Expected one of: ${i}.`)}return r[s]}});var gt=h(oe=>{"use strict";Object.defineProperty(oe,"__esModule",{value:!0});oe.ClickHouseClient=void 0;var _r=P(),_t=Ne(),Ee=class{constructor(e){Object.defineProperty(this,"clientClickHouseSettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"connectionParams",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"connection",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"makeResultSet",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"valuesEncoder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sessionId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logWriter",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let r=e?.log?.LoggerClass?new e.log.LoggerClass:new _r.DefaultLogger,n=(0,_t.prepareConfigWithURL)(e,r,e.impl.handle_specific_url_params??null);this.connectionParams=(0,_t.getConnectionParams)(n,r),this.logWriter=this.connectionParams.log_writer,this.clientClickHouseSettings=this.connectionParams.clickhouse_settings,this.sessionId=e.session_id,this.role=e.role,this.connection=e.impl.make_connection(n,this.connectionParams),this.makeResultSet=e.impl.make_result_set,this.valuesEncoder=e.impl.values_encoder}async query(e){let r=e.format??"JSON",n=gr(e.query,r),s=this.withClientQueryParams(e),{stream:i,query_id:o,response_headers:u}=await this.connection.query({query:n,...s});return this.makeResultSet(i,r,o,l=>{this.logWriter.error({err:l,module:"Client",message:"Error while processing the ResultSet.",args:{session_id:s.session_id,role:s.role,query:n,query_id:o}})},u)}async command(e){let r=Re(e.query.trim());return await this.connection.command({query:r,...this.withClientQueryParams(e)})}async exec(e){let r=Re(e.query.trim()),n="values"in e?e.values:void 0,s=e.decompress_response_stream??!0;return await this.connection.exec({query:r,values:n,decompress_response_stream:s,...this.withClientQueryParams(e)})}async insert(e){if(Array.isArray(e.values)&&e.values.length===0)return{executed:!1,query_id:"",response_headers:{}};let r=e.format||"JSONCompactEachRow";this.valuesEncoder.validateInsertValues(e.values,r);let n=yr(e,r);return{...await this.connection.insert({query:n,values:this.valuesEncoder.encodeValues(e.values,r),...this.withClientQueryParams(e)}),executed:!0}}async ping(){return await this.connection.ping()}async close(){return await this.connection.close()}withClientQueryParams(e){return{clickhouse_settings:{...this.clientClickHouseSettings,...e.clickhouse_settings},query_params:e.query_params,abort_signal:e.abort_signal,query_id:e.query_id,session_id:e.session_id??this.sessionId,role:e.role??this.role,auth:e.auth,http_headers:e.http_headers}}};oe.ClickHouseClient=Ee;function gr(t,e){return t=t.trim(),t=Re(t),t+` 
FORMAT `+e}function Re(t){let e=t.length;for(let r=e;r>0;r--)if(t[r-1]!==";"){e=r;break}return e!==t.length?t.slice(0,e):t}function br(t){return t!=null&&typeof t=="object"&&Object.prototype.hasOwnProperty.call(t,"except")}function yr(t,e){let r="";return t.columns!==void 0&&(Array.isArray(t.columns)&&t.columns.length>0?r=` (${t.columns.join(", ")})`:br(t.columns)&&t.columns.except.length>0&&(r=` (* EXCEPT (${t.columns.except.join(", ")}))`)),`INSERT INTO ${t.table.trim()}${r} FORMAT ${e}`}});var bt=h(m=>{"use strict";Object.defineProperty(m,"__esModule",{value:!0});m.StreamableFormats=m.SupportedRawFormats=m.SupportedJSONFormats=m.SingleDocumentJSONFormats=m.RecordsJSONFormats=m.StreamableJSONFormats=void 0;m.isNotStreamableJSONFamily=wr;m.isStreamableJSONFamily=Sr;m.isSupportedRawFormat=Or;m.validateStreamFormat=vr;m.encodeJSON=Pr;m.StreamableJSONFormats=["JSONEachRow","JSONStringsEachRow","JSONCompactEachRow","JSONCompactStringsEachRow","JSONCompactEachRowWithNames","JSONCompactEachRowWithNamesAndTypes","JSONCompactStringsEachRowWithNames","JSONCompactStringsEachRowWithNamesAndTypes","JSONEachRowWithProgress"];m.RecordsJSONFormats=["JSONObjectEachRow"];m.SingleDocumentJSONFormats=["JSON","JSONStrings","JSONCompact","JSONCompactStrings","JSONColumnsWithMetadata"];m.SupportedJSONFormats=[...m.RecordsJSONFormats,...m.SingleDocumentJSONFormats,...m.StreamableJSONFormats];m.SupportedRawFormats=["CSV","CSVWithNames","CSVWithNamesAndTypes","TabSeparated","TabSeparatedRaw","TabSeparatedWithNames","TabSeparatedWithNamesAndTypes","CustomSeparated","CustomSeparatedWithNames","CustomSeparatedWithNamesAndTypes","Parquet"];m.StreamableFormats=[...m.StreamableJSONFormats,...m.SupportedRawFormats];function wr(t){return m.SingleDocumentJSONFormats.includes(t)||m.RecordsJSONFormats.includes(t)}function Sr(t){return m.StreamableJSONFormats.includes(t)}function Or(t){return m.SupportedRawFormats.includes(t)}function vr(t){if(!m.StreamableFormats.includes(t))throw new Error(`${t} format is not streamable. Streamable formats: ${m.StreamableFormats.join(",")}`);return!0}function Pr(t,e){if(m.SupportedJSONFormats.includes(e))return JSON.stringify(t)+`
`;throw new Error(`The client does not support JSON encoding in [${e}] format.`)}});var wt=h(X=>{"use strict";Object.defineProperty(X,"__esModule",{value:!0});X.TupleParam=void 0;X.formatQueryParams=G;var ae=class{constructor(e){Object.defineProperty(this,"values",{enumerable:!0,configurable:!0,writable:!0,value:e})}};X.TupleParam=ae;function G({value:t,wrapStringInQuotes:e,printNullAsKeyword:r}){if(t==null)return r?"NULL":"\\N";if(Number.isNaN(t))return"nan";if(t===Number.POSITIVE_INFINITY)return"+inf";if(t===Number.NEGATIVE_INFINITY)return"-inf";if(typeof t=="number")return String(t);if(typeof t=="boolean")return t?"1":"0";if(typeof t=="string"){let n="";for(let s=0;s<t.length;s++)switch(t.charCodeAt(s)){case Cr:n+="\\t";break;case qr:n+="\\n";break;case jr:n+="\\r";break;case Nr:n+="\\'";break;case Er:n+="\\\\";break;default:n+=t[s]}return e?`'${n}'`:n}if(Array.isArray(t))return`[${t.map(n=>G({value:n,wrapStringInQuotes:!0,printNullAsKeyword:!0})).join(",")}]`;if(t instanceof Date){let n=Math.floor(t.getTime()/1e3).toString().padStart(10,"0"),s=t.getUTCMilliseconds();return s===0?n:`${n}.${s.toString().padStart(3,"0")}`}if(t instanceof ae)return`(${t.values.map(n=>G({value:n,wrapStringInQuotes:!0,printNullAsKeyword:!0})).join(",")})`;if(t instanceof Map)return yt(t.entries());if(typeof t=="object")return yt(Object.entries(t));throw new Error(`Unsupported value in query parameters: [${t}].`)}function yt(t){let e=[];for(let[r,n]of t)e.push(`${G({value:r,wrapStringInQuotes:!0,printNullAsKeyword:!0})}:${G({value:n,wrapStringInQuotes:!0,printNullAsKeyword:!0})}`);return`{${e.join(",")}}`}var Cr=9,qr=10,jr=13,Nr=39,Er=92});var Ie=h(ue=>{"use strict";Object.defineProperty(ue,"__esModule",{value:!0});ue.SettingsMap=void 0;var Ae=class{constructor(e){Object.defineProperty(this,"record",{enumerable:!0,configurable:!0,writable:!0,value:e})}toString(){return`{${Object.entries(this.record).map(([e,r])=>`'${e}':'${r}'`).join(",")}}`}static from(e){return new this(e)}};ue.SettingsMap=Ae});var St=h(Me=>{"use strict";Object.defineProperty(Me,"__esModule",{value:!0});Me.formatQuerySettings=Ar;var Rr=Ie();function Ar(t){if(typeof t=="boolean")return t?"1":"0";if(typeof t=="number")return String(t);if(typeof t=="string")return t;if(t instanceof Rr.SettingsMap)return t.toString();throw new Error(`Unsupported value in query settings: [${t}].`)}});var le=h(w=>{"use strict";var Ir=w&&w.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r);var s=Object.getOwnPropertyDescriptor(e,r);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,s)}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),Mr=w&&w.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&Ir(e,t,r)};Object.defineProperty(w,"__esModule",{value:!0});w.formatQuerySettings=w.formatQueryParams=w.TupleParam=void 0;Mr(bt(),w);var Ot=wt();Object.defineProperty(w,"TupleParam",{enumerable:!0,get:function(){return Ot.TupleParam}});Object.defineProperty(w,"formatQueryParams",{enumerable:!0,get:function(){return Ot.formatQueryParams}});var Dr=St();Object.defineProperty(w,"formatQuerySettings",{enumerable:!0,get:function(){return Dr.formatQuerySettings}})});var vt=h(Z=>{"use strict";Object.defineProperty(Z,"__esModule",{value:!0});Z.ClickHouseError=void 0;Z.parseError=Hr;var kr=/(Code|Error): (?<code>\d+).*Exception: (?<message>.+)\((?<type>(?=.+[A-Z]{3})[A-Z0-9_]+?)\)/s,ce=class t extends Error{constructor({message:e,code:r,type:n}){super(e),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.code=r,this.type=n,Object.setPrototypeOf(this,t.prototype)}};Z.ClickHouseError=ce;function Hr(t){let e=t instanceof Error,s=(e?t.message:t).match(kr)?.groups;return s?new ce(s):e?t:new Error(t)}});var De=h(D=>{"use strict";var Fr=D&&D.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r);var s=Object.getOwnPropertyDescriptor(e,r);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,s)}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),$r=D&&D.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&Fr(e,t,r)};Object.defineProperty(D,"__esModule",{value:!0});$r(vt(),D)});var Pt=h(ke=>{"use strict";Object.defineProperty(ke,"__esModule",{value:!0});ke.isProgressRow=Lr;function Lr(t){return t!==null&&typeof t=="object"&&"progress"in t&&Object.keys(t).length===1}});var Ft=h(b=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});b.SimpleColumnTypes=b.ColumnTypeParseError=void 0;b.parseColumnType=ee;b.parseDecimalType=qt;b.parseEnumType=jt;b.parseMapType=Nt;b.parseTupleType=Et;b.parseArrayType=Rt;b.parseDateTimeType=At;b.parseDateTime64Type=It;b.parseFixedStringType=Mt;b.asNullableType=Dt;b.getElementsTypes=Ue;var p=class t extends Error{constructor(e,r){super(e),Object.defineProperty(this,"args",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.args=r??{},Object.setPrototypeOf(this,t.prototype)}};b.ColumnTypeParseError=p;b.SimpleColumnTypes=["Bool","UInt8","Int8","UInt16","Int16","UInt32","Int32","UInt64","Int64","UInt128","Int128","UInt256","Int256","Float32","Float64","String","UUID","Date","Date32","IPv4","IPv6"];function ee(t){let e=t,r=!1;e.startsWith(Ct)&&(e=e.slice(Ct.length,-1)),e.startsWith(pe)&&(e=e.slice(pe.length,-1),r=!0);let n;if(b.SimpleColumnTypes.includes(e))n={type:"Simple",columnType:e,sourceType:t};else if(e.startsWith(de))n=qt({sourceType:t,columnType:e});else if(e.startsWith(U))n=It({sourceType:t,columnType:e});else if(e.startsWith(Le))n=At({sourceType:t,columnType:e});else if(e.startsWith(me))n=Mt({sourceType:t,columnType:e});else if(e.startsWith(Fe)||e.startsWith($e))n=jt({sourceType:t,columnType:e});else if(e.startsWith(Y))n=Rt({sourceType:t,columnType:e});else if(e.startsWith(fe))n=Nt({sourceType:t,columnType:e});else if(e.startsWith(he))n=Et({sourceType:t,columnType:e});else throw new p("Unsupported column type",{columnType:e});return r?Dt(n,t):n}function qt({columnType:t,sourceType:e}){if(!t.startsWith(de)||t.length<de.length+5)throw new p("Invalid Decimal type",{sourceType:e,columnType:t});let r=t.slice(de.length,-1).split(", ");if(r.length!==2)throw new p("Expected Decimal type to have both precision and scale",{sourceType:e,columnType:t,split:r});let n=32,s=parseInt(r[0],10);if(Number.isNaN(s)||s<1||s>76)throw new p("Invalid Decimal precision",{columnType:t,sourceType:e,precision:s});let i=parseInt(r[1],10);if(Number.isNaN(i)||i<0||i>s)throw new p("Invalid Decimal scale",{columnType:t,sourceType:e,precision:s,scale:i});return s>38?n=256:s>18?n=128:s>9&&(n=64),{type:"Decimal",params:{precision:s,scale:i,intSize:n},sourceType:e}}function jt({columnType:t,sourceType:e}){let r;if(t.startsWith(Fe))t=t.slice(Fe.length,-1),r=8;else if(t.startsWith($e))t=t.slice($e.length,-1),r=16;else throw new p("Expected Enum to be either Enum8 or Enum16",{columnType:t,sourceType:e});if(t.length<6)throw new p("Invalid Enum type values",{columnType:t,sourceType:e});let n=[],s=[],i=!0,o=!1,u=1;for(let d=1;d<t.length;d++)if(i){if(o)o=!1;else if(t.charCodeAt(d)===Ht)o=!0;else if(t.charCodeAt(d)===kt){let f=t.slice(u,d);if(n.includes(f))throw new p("Duplicate Enum name",{columnType:t,sourceType:e,name:f,names:n,indices:s});n.push(f),d+=4,u=d,i=!1}}else(t.charCodeAt(d)<Tr||t.charCodeAt(d)>xr)&&(c(u,d),d+=2,u=d+1,i=!0,o=!1);if(c(u,t.length),n.length!==s.length)throw new p("Expected Enum to have the same number of names and indices",{columnType:t,sourceType:e,names:n,indices:s});let l={};for(let d=0;d<n.length;d++)l[s[d]]=n[d];return{type:"Enum",values:l,intSize:r,sourceType:e};function c(d,f){let g=parseInt(t.slice(d,f),10);if(Number.isNaN(g)||g<0)throw new p("Expected Enum index to be a valid number",{columnType:t,sourceType:e,names:n,indices:s,index:g,start:d,end:f});if(s.includes(g))throw new p("Duplicate Enum index",{columnType:t,sourceType:e,index:g,names:n,indices:s});s.push(g)}}function Nt({columnType:t,sourceType:e}){if(!t.startsWith(fe)||t.length<fe.length+11)throw new p("Invalid Map type",{columnType:t,sourceType:e});t=t.slice(fe.length,-1);let[r,n]=Ue({columnType:t,sourceType:e},2),s=ee(r);if(s.type==="DateTime64"||s.type==="Nullable"||s.type==="Array"||s.type==="Map"||s.type==="Decimal"||s.type==="Tuple")throw new p("Invalid Map key type",{key:s,sourceType:e});let i=ee(n);return{type:"Map",key:s,value:i,sourceType:e}}function Et({columnType:t,sourceType:e}){if(!t.startsWith(he)||t.length<he.length+5)throw new p("Invalid Tuple type",{columnType:t,sourceType:e});return t=t.slice(he.length,-1),{type:"Tuple",elements:Ue({columnType:t,sourceType:e},1).map(n=>ee(n)),sourceType:e}}function Rt({columnType:t,sourceType:e}){if(!t.startsWith(Y)||t.length<Y.length+5)throw new p("Invalid Array type",{columnType:t,sourceType:e});let r=0;for(;t.length>0&&t.startsWith(Y);)t=t.slice(Y.length,-1),r++;if(r===0||r>10)throw new p("Expected Array to have between 1 and 10 dimensions",{columnType:t});let n=ee(t);if(n.type==="Array")throw new p("Unexpected Array as value type",{columnType:t,sourceType:e});return{type:"Array",value:n,dimensions:r,sourceType:e}}function At({columnType:t,sourceType:e}){if(t.startsWith(He)&&t.length>He.length+4)return{type:"DateTime",timezone:t.slice(He.length+1,-2),sourceType:e};if(t.startsWith(Le)&&t.length===Le.length)return{type:"DateTime",timezone:null,sourceType:e};throw new p("Invalid DateTime type",{columnType:t,sourceType:e})}function It({columnType:t,sourceType:e}){if(!t.startsWith(U)||t.length<U.length+2)throw new p("Invalid DateTime64 type",{columnType:t,sourceType:e});let r=parseInt(t[U.length],10);if(Number.isNaN(r)||r<0||r>9)throw new p("Invalid DateTime64 precision",{columnType:t,sourceType:e,precision:r});let n=null;return t.length>U.length+2&&(n=t.slice(U.length+4,-2)),{type:"DateTime64",timezone:n,precision:r,sourceType:e}}function Mt({columnType:t,sourceType:e}){if(!t.startsWith(me)||t.length<me.length+2)throw new p("Invalid FixedString type",{columnType:t,sourceType:e});let r=parseInt(t.slice(me.length,-1),10);if(Number.isNaN(r)||r<1)throw new p("Invalid FixedString size in bytes",{columnType:t,sourceType:e,sizeBytes:r});return{type:"FixedString",sizeBytes:r,sourceType:e}}function Dt(t,e){if(t.type==="Array"||t.type==="Map"||t.type==="Tuple"||t.type==="Nullable")throw new p(`${t.type} cannot be Nullable`,{sourceType:e});return t.sourceType.startsWith(pe)&&(t.sourceType=t.sourceType.slice(pe.length,-1)),{type:"Nullable",sourceType:e,value:t}}function Ue({columnType:t,sourceType:e},r){let n=[],s=0,i=!1,o=!1,u=0;for(let l=0;l<t.length;l++)o?o=!1:t.charCodeAt(l)===Ht?o=!0:t.charCodeAt(l)===kt?i=!i:i||(t.charCodeAt(l)===Ur?s++:t.charCodeAt(l)===Wr?s--:t.charCodeAt(l)===Jr&&s===0&&(n.push(t.slice(u,l)),l+=2,u=l));if(!s&&u<t.length-1&&n.push(t.slice(u)),n.length<r)throw new p("Expected more elements in the type",{sourceType:e,columnType:t,elements:n,minElements:r});return n}var pe="Nullable(",Ct="LowCardinality(",de="Decimal(",Y="Array(",fe="Map(",Fe="Enum8(",$e="Enum16(",he="Tuple(",Le="DateTime",He="DateTime(",U="DateTime64(",me="FixedString(",kt=39,Ur=40,Wr=41,Jr=44,Tr=48,xr=57,Ht=92});var $t=h(k=>{"use strict";var Br=k&&k.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r);var s=Object.getOwnPropertyDescriptor(e,r);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,s)}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),Qr=k&&k.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&Br(e,t,r)};Object.defineProperty(k,"__esModule",{value:!0});Qr(Ft(),k)});var Lt=h(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});H.withCompressionHeaders=Vr;H.withHttpSettings=zr;H.isSuccessfulResponse=Kr;H.isJWTAuth=Gr;H.isCredentialsAuth=Xr;function Vr({headers:t,enable_request_compression:e,enable_response_compression:r}){return{...t,...r?{"Accept-Encoding":"gzip"}:{},...e?{"Content-Encoding":"gzip"}:{}}}function zr(t,e){return{...e?{enable_http_compression:1}:{},...t}}function Kr(t){return!!(t&&200<=t&&t<300)}function Gr(t){return t!==null&&typeof t=="object"&&"access_token"in t}function Xr(t){return t!==null&&typeof t=="object"&&"username"in t&&"password"in t}});var Ut=h(We=>{"use strict";Object.defineProperty(We,"__esModule",{value:!0});We.sleep=Zr;async function Zr(t){await new Promise(e=>setTimeout(()=>{e(void 0)},t))}});var Jt=h(_e=>{"use strict";Object.defineProperty(_e,"__esModule",{value:!0});_e.transformUrl=Yr;_e.toSearchParams=en;var Wt=le();function Yr({url:t,pathname:e,searchParams:r}){let n=new URL(t);return e&&(n.pathname==="/"?n.pathname=e:n.pathname+=e),r&&(n.search=r?.toString()),n}function en({database:t,query:e,query_params:r,clickhouse_settings:n,session_id:s,query_id:i,role:o}){let u=new URLSearchParams;if(u.set("query_id",i),r!==void 0)for(let[l,c]of Object.entries(r)){let d=(0,Wt.formatQueryParams)({value:c});u.set(`param_${l}`,d)}if(n!==void 0)for(let[l,c]of Object.entries(n))c!==void 0&&u.set(l,(0,Wt.formatQuerySettings)(c));if(t!=="default"&&u.set("database",t),e&&u.set("query",e),s&&u.set("session_id",s),o){if(typeof o=="string")u.set("role",o);else if(Array.isArray(o))for(let l of o)u.append("role",l)}return u}});var Tt=h(A=>{"use strict";var tn=A&&A.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r);var s=Object.getOwnPropertyDescriptor(e,r);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,s)}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),Je=A&&A.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&tn(e,t,r)};Object.defineProperty(A,"__esModule",{value:!0});Je(Lt(),A);Je(Ut(),A);Je(Jt(),A)});var P=h(a=>{"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.parseError=a.DefaultLogger=a.LogWriter=a.isJWTAuth=a.isCredentialsAuth=a.withHttpSettings=a.withCompressionHeaders=a.transformUrl=a.toSearchParams=a.sleep=a.isSuccessfulResponse=a.numberConfigURLValue=a.getConnectionParams=a.enumConfigURLValue=a.booleanConfigURLValue=a.validateStreamFormat=a.isNotStreamableJSONFamily=a.isStreamableJSONFamily=a.isSupportedRawFormat=a.encodeJSON=a.formatQueryParams=a.formatQuerySettings=a.parseColumnType=a.SimpleColumnTypes=a.SettingsMap=a.isProgressRow=a.ClickHouseLogLevel=a.ClickHouseError=a.TupleParam=a.ClickHouseClient=void 0;var rn=gt();Object.defineProperty(a,"ClickHouseClient",{enumerable:!0,get:function(){return rn.ClickHouseClient}});var nn=le();Object.defineProperty(a,"TupleParam",{enumerable:!0,get:function(){return nn.TupleParam}});var sn=De();Object.defineProperty(a,"ClickHouseError",{enumerable:!0,get:function(){return sn.ClickHouseError}});var on=se();Object.defineProperty(a,"ClickHouseLogLevel",{enumerable:!0,get:function(){return on.ClickHouseLogLevel}});var an=Pt();Object.defineProperty(a,"isProgressRow",{enumerable:!0,get:function(){return an.isProgressRow}});var un=Ie();Object.defineProperty(a,"SettingsMap",{enumerable:!0,get:function(){return un.SettingsMap}});var xt=$t();Object.defineProperty(a,"SimpleColumnTypes",{enumerable:!0,get:function(){return xt.SimpleColumnTypes}});Object.defineProperty(a,"parseColumnType",{enumerable:!0,get:function(){return xt.parseColumnType}});var F=le();Object.defineProperty(a,"formatQuerySettings",{enumerable:!0,get:function(){return F.formatQuerySettings}});Object.defineProperty(a,"formatQueryParams",{enumerable:!0,get:function(){return F.formatQueryParams}});Object.defineProperty(a,"encodeJSON",{enumerable:!0,get:function(){return F.encodeJSON}});Object.defineProperty(a,"isSupportedRawFormat",{enumerable:!0,get:function(){return F.isSupportedRawFormat}});Object.defineProperty(a,"isStreamableJSONFamily",{enumerable:!0,get:function(){return F.isStreamableJSONFamily}});Object.defineProperty(a,"isNotStreamableJSONFamily",{enumerable:!0,get:function(){return F.isNotStreamableJSONFamily}});Object.defineProperty(a,"validateStreamFormat",{enumerable:!0,get:function(){return F.validateStreamFormat}});var ge=Ne();Object.defineProperty(a,"booleanConfigURLValue",{enumerable:!0,get:function(){return ge.booleanConfigURLValue}});Object.defineProperty(a,"enumConfigURLValue",{enumerable:!0,get:function(){return ge.enumConfigURLValue}});Object.defineProperty(a,"getConnectionParams",{enumerable:!0,get:function(){return ge.getConnectionParams}});Object.defineProperty(a,"numberConfigURLValue",{enumerable:!0,get:function(){return ge.numberConfigURLValue}});var M=Tt();Object.defineProperty(a,"isSuccessfulResponse",{enumerable:!0,get:function(){return M.isSuccessfulResponse}});Object.defineProperty(a,"sleep",{enumerable:!0,get:function(){return M.sleep}});Object.defineProperty(a,"toSearchParams",{enumerable:!0,get:function(){return M.toSearchParams}});Object.defineProperty(a,"transformUrl",{enumerable:!0,get:function(){return M.transformUrl}});Object.defineProperty(a,"withCompressionHeaders",{enumerable:!0,get:function(){return M.withCompressionHeaders}});Object.defineProperty(a,"withHttpSettings",{enumerable:!0,get:function(){return M.withHttpSettings}});Object.defineProperty(a,"isCredentialsAuth",{enumerable:!0,get:function(){return M.isCredentialsAuth}});Object.defineProperty(a,"isJWTAuth",{enumerable:!0,get:function(){return M.isJWTAuth}});var Bt=se();Object.defineProperty(a,"LogWriter",{enumerable:!0,get:function(){return Bt.LogWriter}});Object.defineProperty(a,"DefaultLogger",{enumerable:!0,get:function(){return Bt.DefaultLogger}});var ln=De();Object.defineProperty(a,"parseError",{enumerable:!0,get:function(){return ln.parseError}})});var Te=h($=>{"use strict";var cn=$&&$.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty($,"__esModule",{value:!0});$.isStream=fn;$.getAsText=hn;$.mapStream=mn;var dn=cn(require("stream")),Qt=Math.pow(2,29)-24;function fn(t){return t!==null&&typeof t.pipe=="function"}async function hn(t){let e="",r=new TextDecoder;for await(let s of t){let i=r.decode(s,{stream:!0});if(i.length+e.length>Qt)throw new Error(`The response length exceeds the maximum allowed size of V8 String: ${Qt}; consider limiting the amount of requested rows.`);e+=i}let n=r.decode();return n&&(e+=n),e}function mn(t){return new dn.default.Transform({objectMode:!0,transform(e,r,n){n(null,t(e))}})}});var Vt=h(W=>{"use strict";var pn=W&&W.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(W,"__esModule",{value:!0});W.NodeValuesEncoder=void 0;var be=P(),_n=pn(require("stream")),ye=Te(),xe=class{encodeValues(e,r){if((0,ye.isStream)(e))return e.readableObjectMode?_n.default.pipeline(e,(0,ye.mapStream)(n=>(0,be.encodeJSON)(n,r)),gn):e;if(Array.isArray(e))return e.map(n=>(0,be.encodeJSON)(n,r)).join("");if(typeof e=="object")return(0,be.encodeJSON)(e,r);throw new Error(`Cannot encode values of type ${typeof e} with ${r} format`)}validateInsertValues(e,r){if(!Array.isArray(e)&&!(0,ye.isStream)(e)&&typeof e!="object")throw new Error(`Insert expected "values" to be an array, a stream of values or a JSON object, got: ${typeof e}`);if((0,ye.isStream)(e)){if((0,be.isSupportedRawFormat)(r)){if(e.readableObjectMode)throw new Error(`Insert for ${r} expected Readable Stream with disabled object mode.`)}else if(!e.readableObjectMode)throw new Error(`Insert for ${r} expected Readable Stream with enabled object mode.`)}}};W.NodeValuesEncoder=xe;function gn(t){t&&console.error(t)}});var zt=h(Be=>{"use strict";Object.defineProperty(Be,"__esModule",{value:!0});Be.getProcessVersion=bn;function bn(){return process.version}});var Kt=h(Qe=>{"use strict";Object.defineProperty(Qe,"__esModule",{value:!0});Qe.default="1.11.0"});var Gt=h(C=>{"use strict";var yn=C&&C.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r);var s=Object.getOwnPropertyDescriptor(e,r);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,s)}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),wn=C&&C.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),Sn=C&&C.__importStar||function(){var t=function(e){return t=Object.getOwnPropertyNames||function(r){var n=[];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(n[n.length]=s);return n},t(e)};return function(e){if(e&&e.__esModule)return e;var r={};if(e!=null)for(var n=t(e),s=0;s<n.length;s++)n[s]!=="default"&&yn(r,e,n[s]);return wn(r,e),r}}(),On=C&&C.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(C,"__esModule",{value:!0});C.getUserAgent=Cn;var vn=Sn(require("os")),Pn=On(Kt());function Cn(t){let e=`clickhouse-js/${Pn.default} (lv:nodejs/${process.version}; os:${vn.platform()})`;return t?`${t} ${e}`:e}});var Se=h(j=>{"use strict";var qn=j&&j.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r);var s=Object.getOwnPropertyDescriptor(e,r);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,s)}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),we=j&&j.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&qn(e,t,r)};Object.defineProperty(j,"__esModule",{value:!0});we(Te(),j);we(Vt(),j);we(zt(),j);we(Gt(),j)});var Zt=h(J=>{"use strict";var Xt=J&&J.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(J,"__esModule",{value:!0});J.decompressResponse=En;J.isDecompressionError=Rn;var jn=Xt(require("stream")),Nn=Xt(require("zlib"));function En(t,e){let r=t.headers["content-encoding"];return r==="gzip"?{response:jn.default.pipeline(t,Nn.default.createGunzip(),function(s){s&&e.error({message:"An error occurred while decompressing the response",err:s})})}:r!==void 0?{error:new Error(`Unexpected encoding: ${r}`)}:{response:t}}function Rn(t){return t.error!==void 0}});var ze=h(Ve=>{"use strict";Object.defineProperty(Ve,"__esModule",{value:!0});Ve.drainStream=An;async function An(t){return new Promise((e,r)=>{function n(){}function s(){u(),e()}function i(l){u(),r(l)}function o(){u()}function u(){t.removeListener("data",n),t.removeListener("end",s),t.removeListener("error",i),t.removeListener("onClose",o)}t.on("data",n),t.on("end",s),t.on("error",i),t.on("close",o)})}});var te=h(T=>{"use strict";var Ye=T&&T.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(T,"__esModule",{value:!0});T.NodeBaseConnection=void 0;var y=P(),Yt=Ye(require("crypto")),Ke=Ye(require("stream")),In=Ye(require("zlib")),Ge=Se(),er=Zt(),Xe=ze(),Ze=class{constructor(e,r){if(Object.defineProperty(this,"params",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"agent",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"defaultAuthHeader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"defaultHeaders",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logger",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"knownSockets",{enumerable:!0,configurable:!0,writable:!0,value:new WeakMap}),Object.defineProperty(this,"idleSocketTTL",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e.auth.type==="Credentials")this.defaultAuthHeader=`Basic ${Buffer.from(`${e.auth.username}:${e.auth.password}`).toString("base64")}`;else if(e.auth.type==="JWT")this.defaultAuthHeader=`Bearer ${e.auth.access_token}`;else throw new Error(`Unknown auth type: ${e.auth.type}`);this.defaultHeaders={Connection:this.params.keep_alive.enabled?"keep-alive":"close","User-Agent":(0,Ge.getUserAgent)(this.params.application_id)},this.logger=e.log_writer,this.idleSocketTTL=e.keep_alive.idle_socket_ttl}async ping(){let e=new AbortController;try{let{stream:r}=await this.request({method:"GET",url:(0,y.transformUrl)({url:this.params.url,pathname:"/ping"}),abort_signal:e.signal,headers:this.buildRequestHeaders()},"Ping");return await(0,Xe.drainStream)(r),{success:!0}}catch(r){return e.abort("Ping failed"),this.logger.warn({message:this.httpRequestErrorMessage("Ping"),err:r}),{success:!1,error:r}}}async query(e){let r=this.getQueryId(e.query_id),n=(0,y.withHttpSettings)(e.clickhouse_settings,this.params.compression.decompress_response),s=(0,y.toSearchParams)({database:this.params.database,query_params:e.query_params,session_id:e.session_id,clickhouse_settings:n,query_id:r,role:e.role}),{controller:i,controllerCleanup:o}=this.getAbortController(e),u=n.enable_http_compression===1;try{let{stream:l,response_headers:c}=await this.request({method:"POST",url:(0,y.transformUrl)({url:this.params.url,searchParams:s}),body:e.query,abort_signal:i.signal,enable_response_compression:u,headers:this.buildRequestHeaders(e)},"Query");return{stream:l,query_id:r,response_headers:c}}catch(l){throw i.abort("Query HTTP request failed"),this.logRequestError({op:"Query",query_id:r,query_params:e,search_params:s,err:l,extra_args:{decompress_response:u,clickhouse_settings:n}}),l}finally{o()}}async insert(e){let r=this.getQueryId(e.query_id),n=(0,y.toSearchParams)({database:this.params.database,clickhouse_settings:e.clickhouse_settings,query_params:e.query_params,query:e.query,session_id:e.session_id,role:e.role,query_id:r}),{controller:s,controllerCleanup:i}=this.getAbortController(e);try{let{stream:o,summary:u,response_headers:l}=await this.request({method:"POST",url:(0,y.transformUrl)({url:this.params.url,searchParams:n}),body:e.values,abort_signal:s.signal,enable_request_compression:this.params.compression.compress_request,parse_summary:!0,headers:this.buildRequestHeaders(e)},"Insert");return await(0,Xe.drainStream)(o),{query_id:r,summary:u,response_headers:l}}catch(o){throw s.abort("Insert HTTP request failed"),this.logRequestError({op:"Insert",query_id:r,query_params:e,search_params:n,err:o,extra_args:{clickhouse_settings:e.clickhouse_settings??{}}}),o}finally{i()}}async exec(e){return this.runExec({...e,op:"Exec"})}async command(e){let{stream:r,query_id:n,summary:s,response_headers:i}=await this.runExec({...e,op:"Command"});return await(0,Xe.drainStream)(r),{query_id:n,summary:s,response_headers:i}}async close(){this.agent!==void 0&&this.agent.destroy!==void 0&&this.agent.destroy()}defaultHeadersWithOverride(e){return{...this.params.http_headers??{},...e?.http_headers??{},...this.defaultHeaders}}buildRequestHeaders(e){let r=this.defaultHeadersWithOverride(e);return(0,y.isJWTAuth)(e?.auth)?{...r,Authorization:`Bearer ${e.auth.access_token}`}:this.params.set_basic_auth_header?(0,y.isCredentialsAuth)(e?.auth)?{...r,Authorization:`Basic ${Buffer.from(`${e.auth.username}:${e.auth.password}`).toString("base64")}`}:{...r,Authorization:this.defaultAuthHeader}:{...r}}getQueryId(e){return e||Yt.default.randomUUID()}getAbortController(e){let r=new AbortController;function n(){r.abort()}return e.abort_signal?.addEventListener("abort",n),{controller:r,controllerCleanup:()=>{e.abort_signal?.removeEventListener("abort",n)}}}logResponse(e,r,n,s,i){let{authorization:o,host:u,...l}=r.getHeaders(),c=Date.now()-i;this.params.log_writer.debug({module:"HTTP Adapter",message:`${e}: got a response from ClickHouse`,args:{request_method:n.method,request_path:n.url.pathname,request_params:n.url.search,request_headers:l,response_status:s.statusCode,response_headers:s.headers,response_time_ms:c}})}logRequestError({op:e,err:r,query_id:n,query_params:s,search_params:i,extra_args:o}){this.logger.error({message:this.httpRequestErrorMessage(e),err:r,args:{query:s.query,search_params:i?.toString()??"",with_abort_signal:s.abort_signal!==void 0,session_id:s.session_id,query_id:n,...o}})}httpRequestErrorMessage(e){return`${e}: HTTP request error.`}parseSummary(e,r){let n=r.headers["x-clickhouse-summary"];if(typeof n=="string")try{return JSON.parse(n)}catch(s){this.logger.error({message:`${e}: failed to parse X-ClickHouse-Summary header.`,args:{"X-ClickHouse-Summary":n},err:s})}}async runExec(e){let r=this.getQueryId(e.query_id),n=e.values!==void 0,s=(0,y.withHttpSettings)(e.clickhouse_settings,this.params.compression.decompress_response),i={query:n?e.query:void 0,database:this.params.database,query_params:e.query_params,session_id:e.session_id,role:e.role,clickhouse_settings:s,query_id:r},o=(0,y.toSearchParams)(i),{controller:u,controllerCleanup:l}=this.getAbortController(e),c=e.op==="Exec"?e.decompress_response_stream??this.params.compression.decompress_response:!1;try{let{stream:d,summary:f,response_headers:g}=await this.request({method:"POST",url:(0,y.transformUrl)({url:this.params.url,searchParams:o}),body:n?e.values:e.query,abort_signal:u.signal,parse_summary:!0,enable_request_compression:this.params.compression.compress_request,enable_response_compression:this.params.compression.decompress_response,try_decompress_response_stream:c,headers:this.buildRequestHeaders(e)},e.op);return{stream:d,query_id:r,summary:f,response_headers:g}}catch(d){throw u.abort(`${e.op} HTTP request failed`),this.logRequestError({op:e.op,query_id:r,query_params:e,search_params:o,err:d,extra_args:{clickhouse_settings:e.clickhouse_settings??{}}}),d}finally{l()}}async request(e,r){return await(0,y.sleep)(0),new Promise((n,s)=>{let i=Date.now(),o=this.createClientRequest(e);function u(_){V(),s(_)}let l=async _=>{this.logResponse(r,o,e,_,i);let S,v=e.try_decompress_response_stream??!0,z=!(0,y.isSuccessfulResponse)(_.statusCode);if(v||z){let O=(0,er.decompressResponse)(_,this.logger);if((0,er.isDecompressionError)(O))return s(O.error);S=O.response}else S=_;if(z)try{let O=await(0,Ge.getAsText)(S);s((0,y.parseError)(O))}catch(O){s(O)}else return n({stream:S,summary:e.parse_summary?this.parseSummary(r,_):void 0,response_headers:{..._.headers}})};function c(){V(),o.once("error",function(){}),s(new Error("The user aborted a request."))}function d(){V()}function f(){if(o.writableEnded)return;let _=(0,Ge.isStream)(e.body)?e.body:Ke.default.Readable.from([e.body]),S=v=>{v&&(V(),s(v))};e.enable_request_compression?Ke.default.pipeline(_,In.default.createGzip(),o,S):Ke.default.pipeline(_,o,S)}let g=_=>{if(this.params.keep_alive.enabled&&this.params.keep_alive.idle_socket_ttl>0){let S=this.knownSockets.get(_);if(S===void 0){let v=Yt.default.randomUUID();this.logger.trace({message:`Using a fresh socket ${v}, setting up a new 'free' listener`}),this.knownSockets.set(_,{id:v,idle_timeout_handle:void 0}),_.on("free",()=>{this.logger.trace({message:`Socket ${v} was released`});let O=setTimeout(()=>{this.logger.trace({message:`Removing socket ${v} after ${this.idleSocketTTL} ms of idle`}),this.knownSockets.delete(_),_.destroy()},this.idleSocketTTL).unref();this.knownSockets.set(_,{id:v,idle_timeout_handle:O})});let z=()=>{let O=this.knownSockets.get(_);O?.idle_timeout_handle&&clearTimeout(O.idle_timeout_handle),this.logger.trace({message:`Socket ${v} was closed or ended, 'free' listener removed`})};_.once("end",z),_.once("close",z)}else clearTimeout(S.idle_timeout_handle),this.logger.trace({message:`Reusing socket ${S.id}`}),this.knownSockets.set(_,{...S,idle_timeout_handle:void 0})}f(),_.setTimeout(this.params.request_timeout,ne)};function ne(){V(),o.destroy(),s(new Error("Timeout error."))}function V(){o.socket!==null&&(o.socket.setTimeout(0),o.socket.removeListener("timeout",ne)),o.removeListener("socket",g),o.removeListener("response",l),o.removeListener("error",u),o.removeListener("close",d),e.abort_signal!==void 0&&o.removeListener("abort",c)}if(o.on("socket",g),o.on("response",l),o.on("error",u),o.on("close",d),e.abort_signal!==void 0&&e.abort_signal.addEventListener("abort",c,{once:!0}),!e.body)return o.end()})}};T.NodeBaseConnection=Ze});var tt=h(x=>{"use strict";var Mn=x&&x.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(x,"__esModule",{value:!0});x.NodeHttpConnection=void 0;var Dn=P(),tr=Mn(require("http")),kn=te(),et=class extends kn.NodeBaseConnection{constructor(e){let r=new tr.default.Agent({keepAlive:e.keep_alive.enabled,maxSockets:e.max_open_connections});super(e,r)}createClientRequest(e){let r=(0,Dn.withCompressionHeaders)({headers:e.headers,enable_request_compression:e.enable_request_compression,enable_response_compression:e.enable_response_compression});return tr.default.request(e.url,{method:e.method,agent:this.agent,timeout:this.params.request_timeout,signal:e.abort_signal,headers:r})}};x.NodeHttpConnection=et});var nt=h(B=>{"use strict";var Hn=B&&B.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(B,"__esModule",{value:!0});B.NodeHttpsConnection=void 0;var rr=P(),nr=Hn(require("https")),Fn=te(),rt=class extends Fn.NodeBaseConnection{constructor(e){let r=new nr.default.Agent({keepAlive:e.keep_alive.enabled,maxSockets:e.max_open_connections,ca:e.tls?.ca_cert,key:e.tls?.type==="Mutual"?e.tls.key:void 0,cert:e.tls?.type==="Mutual"?e.tls.cert:void 0});super(e,r)}buildRequestHeaders(e){if(this.params.tls!==void 0){if(this.params.auth.type==="JWT")throw new Error("JWT auth is not supported with HTTPS connection using custom certificates");let r;(0,rr.isCredentialsAuth)(e?.auth)?r={...this.defaultHeadersWithOverride(e),"X-ClickHouse-User":e.auth.username,"X-ClickHouse-Key":e.auth.password}:r={...this.defaultHeadersWithOverride(e),"X-ClickHouse-User":this.params.auth.username,"X-ClickHouse-Key":this.params.auth.password};let n=this.params.tls.type;switch(n){case"Basic":return r;case"Mutual":return{...r,"X-ClickHouse-SSL-Certificate-Auth":"on"};default:throw new Error(`Unknown TLS type: ${n}`)}}return super.buildRequestHeaders(e)}createClientRequest(e){let r=(0,rr.withCompressionHeaders)({headers:e.headers,enable_request_compression:e.enable_request_compression,enable_response_compression:e.enable_response_compression});return nr.default.request(e.url,{method:e.method,agent:this.agent,timeout:this.params.request_timeout,signal:e.abort_signal,headers:r})}};B.NodeHttpsConnection=rt});var ir=h(Q=>{"use strict";var sr=Q&&Q.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(Q,"__esModule",{value:!0});Q.NodeCustomAgentConnection=void 0;var $n=sr(require("http")),Ln=sr(require("https")),Un=te(),Wn=P(),st=class extends Un.NodeBaseConnection{constructor(e){if(!e.http_agent)throw new Error("http_agent is required to create NodeCustomAgentConnection");super(e,e.http_agent),Object.defineProperty(this,"httpRequestFn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e.url.protocol.startsWith("https")?this.httpRequestFn=Ln.default.request:this.httpRequestFn=$n.default.request}createClientRequest(e){let r=(0,Wn.withCompressionHeaders)({headers:e.headers,enable_request_compression:e.enable_request_compression,enable_response_compression:e.enable_response_compression});return this.httpRequestFn(e.url,{method:e.method,agent:this.agent,timeout:this.params.request_timeout,signal:e.abort_signal,headers:r})}};Q.NodeCustomAgentConnection=st});var or=h(it=>{"use strict";Object.defineProperty(it,"__esModule",{value:!0});it.createConnection=Bn;var Jn=ir(),Tn=tt(),xn=nt();function Bn({connection_params:t,tls:e,keep_alive:r,http_agent:n,set_basic_auth_header:s}){if(n!==void 0)return new Jn.NodeCustomAgentConnection({...t,set_basic_auth_header:s,keep_alive:r,http_agent:n});switch(t.url.protocol){case"http:":return new Tn.NodeHttpConnection({...t,set_basic_auth_header:s,keep_alive:r});case"https:":return new xn.NodeHttpsConnection({...t,set_basic_auth_header:s,keep_alive:r,tls:e});default:throw new Error("Only HTTP and HTTPS protocols are supported")}}});var ar=h(N=>{"use strict";var Qn=N&&N.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r);var s=Object.getOwnPropertyDescriptor(e,r);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,s)}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),Oe=N&&N.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&Qn(e,t,r)};Object.defineProperty(N,"__esModule",{value:!0});Oe(te(),N);Oe(tt(),N);Oe(nt(),N);Oe(or(),N)});var lt=h(E=>{"use strict";var Vn=E&&E.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r);var s=Object.getOwnPropertyDescriptor(e,r);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,s)}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),zn=E&&E.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),Kn=E&&E.__importStar||function(){var t=function(e){return t=Object.getOwnPropertyNames||function(r){var n=[];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(n[n.length]=s);return n},t(e)};return function(e){if(e&&e.__esModule)return e;var r={};if(e!=null)for(var n=t(e),s=0;s<n.length;s++)n[s]!=="default"&&Vn(r,e,n[s]);return zn(r,e),r}}();Object.defineProperty(E,"__esModule",{value:!0});E.ResultSet=void 0;var ot=P(),Gn=require("buffer"),ur=Kn(require("stream")),lr=Se(),cr=10,ut=class t{constructor(e,r,n,s,i){Object.defineProperty(this,"_stream",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"format",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"query_id",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"response_headers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"log_error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.log_error=s??(o=>console.error(o)),this.response_headers=i!==void 0?Object.freeze(i):{}}async text(){if(this._stream.readableEnded)throw Error(at);return(await(0,lr.getAsText)(this._stream)).toString()}async json(){if(this._stream.readableEnded)throw Error(at);if((0,ot.isStreamableJSONFamily)(this.format)){let e=[],r=this.stream();for await(let n of r)for(let s of n)e.push(s.json());return e}if((0,ot.isNotStreamableJSONFamily)(this.format)){let e=await(0,lr.getAsText)(this._stream);return JSON.parse(e)}throw new Error(`Cannot decode ${this.format} as JSON`)}stream(){if(this._stream.readableEnded)throw Error(at);(0,ot.validateStreamFormat)(this.format);let e=[],r=this.log_error,n=new ur.Transform({transform(i,o,u){let l=[],c=0,d=i.indexOf(cr);if(d!==-1){let f;e.length>0?(f=Gn.Buffer.concat([...e,i.subarray(0,d)],e.reduce((g,ne)=>g+ne.length,0)+d).toString(),e=[]):f=i.subarray(0,d).toString(),l.push({text:f,json(){return JSON.parse(f)}}),c=d+1;do{if(d=i.indexOf(cr,c),d!==-1){let g=i.subarray(c,d).toString();l.push({text:g,json(){return JSON.parse(g)}})}else e.push(i.subarray(c)),this.push(l);c=d+1}while(d!==-1)}else e.push(i);u()},autoDestroy:!0,objectMode:!0});return ur.default.pipeline(this._stream,n,function(o){o&&o.name!=="AbortError"&&o.message!==dr&&r(o)})}close(){this._stream.destroy(new Error(dr))}static instance({stream:e,format:r,query_id:n,log_error:s,response_headers:i}){return new t(e,r,n,s,i)}};E.ResultSet=ut;var at="Stream has been already consumed",dr="ResultSet has been closed"});var fr=h(ve=>{"use strict";Object.defineProperty(ve,"__esModule",{value:!0});ve.NodeConfigImpl=void 0;var Xn=P(),Zn=ar(),Yn=lt(),es=Se();ve.NodeConfigImpl={handle_specific_url_params:(t,e)=>{let r={...t},n=new Set,s=new Set,i=[...e.searchParams.keys()];return i.length>0&&i.forEach(o=>{let u=e.searchParams.get(o);switch(o){case"keep_alive_idle_socket_ttl":r.keep_alive===void 0&&(r.keep_alive={}),r.keep_alive.idle_socket_ttl=(0,Xn.numberConfigURLValue)({key:o,value:u,min:0}),s.add(o);break;default:n.add(o)}}),{config:r,unknown_params:n,handled_params:s}},make_connection:(t,e)=>{let r;t.tls!==void 0&&("cert"in t.tls&&"key"in t.tls?r={type:"Mutual",...t.tls}:r={type:"Basic",...t.tls});let n={enabled:t?.keep_alive?.enabled??!0,idle_socket_ttl:t?.keep_alive?.idle_socket_ttl??2500};return(0,Zn.createConnection)({connection_params:e,set_basic_auth_header:t.set_basic_auth_header??!0,http_agent:t.http_agent,keep_alive:n,tls:r})},values_encoder:new es.NodeValuesEncoder,make_result_set:(t,e,r,n,s)=>Yn.ResultSet.instance({stream:t,format:e,query_id:r,log_error:n,response_headers:s})}});var dt=h(re=>{"use strict";Object.defineProperty(re,"__esModule",{value:!0});re.NodeClickHouseClient=void 0;re.createClient=rs;var hr=P(),ts=fr(),ct=class extends hr.ClickHouseClient{query(e){return super.query(e)}};re.NodeClickHouseClient=ct;function rs(t){return new hr.ClickHouseClient({impl:ts.NodeConfigImpl,...t||{}})}});Object.defineProperty(exports,"__esModule",{value:!0});exports.TupleParam=exports.isProgressRow=exports.SimpleColumnTypes=exports.parseColumnType=exports.SettingsMap=exports.ClickHouseLogLevel=exports.ClickHouseError=exports.drainStream=exports.ResultSet=exports.createClient=exports.ClickHouseClient=void 0;var ns=dt();Object.defineProperty(exports,"ClickHouseClient",{enumerable:!0,get:function(){return ns.NodeClickHouseClient}});var ss=dt();Object.defineProperty(exports,"createClient",{enumerable:!0,get:function(){return ss.createClient}});var is=lt();Object.defineProperty(exports,"ResultSet",{enumerable:!0,get:function(){return is.ResultSet}});var os=ze();Object.defineProperty(exports,"drainStream",{enumerable:!0,get:function(){return os.drainStream}});var L=P();Object.defineProperty(exports,"ClickHouseError",{enumerable:!0,get:function(){return L.ClickHouseError}});Object.defineProperty(exports,"ClickHouseLogLevel",{enumerable:!0,get:function(){return L.ClickHouseLogLevel}});Object.defineProperty(exports,"SettingsMap",{enumerable:!0,get:function(){return L.SettingsMap}});Object.defineProperty(exports,"parseColumnType",{enumerable:!0,get:function(){return L.parseColumnType}});Object.defineProperty(exports,"SimpleColumnTypes",{enumerable:!0,get:function(){return L.SimpleColumnTypes}});Object.defineProperty(exports,"isProgressRow",{enumerable:!0,get:function(){return L.isProgressRow}});Object.defineProperty(exports,"TupleParam",{enumerable:!0,get:function(){return L.TupleParam}});
